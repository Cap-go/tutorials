---
import { useRuntimeConfig } from '../config/app'
import { SitemapStream, streamToPromise } from 'sitemap'

try {
  const config = useRuntimeConfig()
  const smStream = new SitemapStream({ hostname: config.public.baseUrl })
  smStream.write({ url: '/', changefreq: 'daily', priority: 1 })
  const tuts = await Astro.glob('../content/plugins-tutorials/**/*.md')
  tuts.forEach((article: any) => {
    smStream.write({
      priority: 0.5,
      changefreq: 'weekly',
      url: `/plugins/${article.file.substring(article.file.lastIndexOf('/') + 1).replace('.md', '')}/`,
    })
  })
  smStream.end()
  const sitemap = await streamToPromise(smStream)
  return new Response(sitemap, {
    status: 200,
    headers: {
      'Content-Type': 'text/xml',
    },
  })
} catch (e) {
  console.log(e)
  return new Response(null, {
    status: 404,
    // @ts-ignore
    location: '/404',
    headers: {
      'Content-Type': 'text/html',
    },
  })
}
---
